name: 'ECS Blue-Green Deployment'

description: 'Deploy and manage ECS services with Blue-Green deployment'

inputs:
  cluster-name:
    description: 'ECS Cluster name'
    required: true
  service-name:
    description: 'ECS Service name for the primary version'
    required: true
  backup-service-name:
    description: 'ECS Service name for the backup version'
    required: true
  task-definition:
    description: 'ECS Task Definition'
    required: true
  container-name:
    description: 'Name of the container in the task definition'
    required: true
  ecr-repository:
    description: 'ECR Repository name'
    required: true
  aws-region:  
    description: 'AWS region'
    required: true
  repo-uri:  
    description: 'ECR repository URI'
    required: true
  registry-type:
    description: 'Type of registry (public/private)'
    required: true
    default: 'private'
  image-tag:
    description: 'docker image tag'
    required: true


runs:
  using: 'composite'
  steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Get ECR Login
      run: |
        if [ "${{ inputs.registry-type }}" == "public" ]; then
          aws ecr-public get-login-password --region ${{ inputs.aws-region }} | docker login --username AWS --password-stdin ${{inputs.repo-uri}}
        else
          aws ecr get-login-password --region ${{ inputs.aws-region }} | docker login --username AWS --password-stdin ${{ inputs.repo-uri }}
        fi
        docker pull ${{ inputs.repo-uri }}:${{ inputs.image-tag }}
      shell: bash

    - name: Get Latest ECR Image URI
      id: ecr
      run: |
        IMAGE_URI=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ inputs.repo-uri }}:${{ inputs.image-tag }})
        echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
        echo "Retrieved Image URI: $IMAGE_URI"
      shell: bash

    - name: Update Task Definition Image
      id: update-task-def
      run: |
        TASK_DEFINITION=$(aws ecs describe-task-definition --task-definition "${{ inputs.task-definition }}" --region "${{ inputs.aws-region }}")
        NEW_TASK_DEFINITION=$(echo "$NEW_TASK_DEFINITION" | jq --arg IMAGE "$IMAGE_URI" '.taskDefinition | .containerDefinitions[0].image = "$IMAGE_URI" | del(.taskDefinitionArn) | del(.revision) | del(.status) | del(.requiresAttributes) | del(.compatibilities)')
      env:
        IMAGE_URI: ${{ env.IMAGE_URI }}
      shell: bash

    - name: Register Updated Task Definition
      run: |
        aws ecs register-task-definition --region "${{ inputs.aws-region }}" --family "$NEW_TASK_DEFINITION" --container-definitions "$IMAGE_URI"
      shell: bash

    - name: Deploy Primary Version
      run: |
        aws ecs update-service --cluster ${{ inputs.cluster-name }} --service ${{ inputs.service-name }} --task-definition "${{ inputs.task-definition }}:latest"
      shell: bash

    - name: Wait for Primary Deployment to Stabilize
      run: |
        aws ecs wait services-stable --cluster ${{ inputs.cluster-name }} --services ${{ inputs.service-name }}
      shell: bash

    - name: Redirect Traffic to Backup Service
      run: |
        aws ecs update-service --cluster ${{ inputs.cluster-name }} --service ${{ inputs.service-name }} --desired-count 0
        aws ecs update-service --cluster ${{ inputs.cluster-name }} --service ${{ inputs.backup-service-name }} --desired-count 1
      shell: bash

    - name: Wait for Traffic Redirection to Stabilize
      run: |
        aws ecs wait services-stable --cluster ${{ inputs.cluster-name }} --services ${{ inputs.backup-service-name }}
      shell: bash

    - name: Cleanup Old Version
      run: |
        aws ecs update-service --cluster ${{ inputs.cluster-name }} --service ${{ inputs.service-name }} --desired-count 0
      shell: bash

    - name: Deploy New Version to the primary service
      run: |
        aws ecs update-service --cluster ${{ inputs.cluster-name }} --service ${{ inputs.service-name }} --task-definition "${{ inputs.task-definition }}:latest"
      shell: bash

    - name: Wait for New Deployment to Stabilize
      run: |
        aws ecs wait services-stable --cluster ${{ inputs.cluster-name }} --services ${{ inputs.service-name }}
      shell: bash

    - name: Redirect Traffic to Primary Service
      run: |
        aws ecs update-service --cluster ${{ inputs.cluster-name }} --service ${{ inputs.service-name }} --desired-count 1
        aws ecs update-service --cluster ${{ inputs.cluster-name }} --service ${{ inputs.backup-service-name }} --desired-count 0
      shell: bash

    - name: Wait for Traffic Redirection to Stabilize
      run: |
        aws ecs wait services-stable --cluster ${{ inputs.cluster-name }} --services ${{ inputs.service-name }}
      shell: bash

    - name: Cleanup Old Version
      run: |
        aws ecs update-service --cluster ${{ inputs.cluster-name }} --service ${{ inputs.backup-service-name }} --desired-count 0
      shell: bash
